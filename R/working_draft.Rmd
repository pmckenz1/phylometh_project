---
title: "Working Draft"
author: "Patrick McKenzie & Rachel Swenie"
date: "April 24, 2017"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r include = FALSE}
set.seed(12345)
library(ape)
```
# Biogeography Model

Using data matrices, movement function, and speciation function to reconstruct ancestral ranges.

# Sample tree

(A:1000,((B:400,C:400):200,(D:200,E:200):400):400);

\vspace{12pt}

```{r echo = FALSE}
tree <- read.tree(text="(A:1000,((B:400,C:400):200,(D:200,E:200):400):400);")
plot.phylo(tree)
edgelabels(tree$edge.length, bg = "white",col="black")
```

# Generate a species range in a matrix with this cool function

Input the number of matrix rows and columns as the first two arguments, and the number of cells you want to be occupied by the species as the second argument. If you want to species' range to be centered around a particular point, designate that using a two-element vector as the argument for "startingcell" -- otherwise, the range will be centered around a random point.

\vspace{12pt}

```{r}
get_random_species_range <- function(nrow, ncol, numbercells, startingcell = NULL) {
  rows <- nrow
  cols <- ncol
  randommatrix <- matrix(rep(0,rows*cols), nrow = rows, ncol = cols)
  if (is.null(startingcell)) {
    index <- sample(rows*cols,1)
    randommatrix[index] <- 1
    pointindices <- arrayInd(index,c(rows,cols))
  } else {
    pointindices <- startingcell
    dim(pointindices) <- c(1,2)
  }
  
  while(sum(randommatrix) < numbercells) {
  workingcell <- pointindices[sample(nrow(pointindices),1),]
  random_adjacent <- sample(c(-1:1),2,replace = TRUE) #new cell row and col
  check_occupancy <- workingcell + random_adjacent
  if (sum(check_occupancy > 0) == 2 && sum(check_occupancy <= c(rows,cols)) == 2) {
    if (randommatrix[check_occupancy[1],check_occupancy[2]] == 0) {
      randommatrix[check_occupancy[1],check_occupancy[2]] <- 1
      pointindices <- rbind(pointindices,check_occupancy)
    }
  }
  }
  randommatrix
}
```

\vspace{12pt}

# Movement and speciation

For each step in time, the following eqation is applied to each cell to calculate its new "probability" value. 
*  These are normalized at each node and no longer represent true probabilities when moving up the tree. 

$$P_{s,x,y}(t-1) = E_{x,y}(t-1)(((1-P_{s,x,y}(t))*\alpha*\frac{\bar{N}}{8}) + (P_{s,x,y}(t)*\beta*\frac{\bar{N}}{8}))$$

The same equation is written out in code below. Note that `get_Nbar()` is a separate function written to calculate $\bar{N}$.

\vspace{12pt}

```{r include = FALSE}
get_Nbar <- function(Ps,i,q) {
  if (i > 1 && i < nrow(Ps) && q > 1 && q < ncol(Ps)) {
    Nbar <- sum(Ps[(i-1):(i+1),(q-1):(q+1)]) - Ps[i,q]
  }
  if (i == 1 && q > 1 && q < ncol(Ps)) {
    Nbar <- sum(Ps[(i):(i+1),(q-1):(q+1)]) - Ps[i,q]
  }
  if (i == nrow(Ps) && q > 1 && q < ncol(Ps)) {
    Nbar <- sum(Ps[(i-1):(i),(q-1):(q+1)]) - Ps[i,q]
  }
  if (i > 1 && i < nrow(Ps) && q == 1) {
    Nbar <- sum(Ps[(i-1):(i+1),(q):(q+1)]) - Ps[i,q]
  }
  if (i > 1 && i < nrow(Ps) && q == ncol(Ps)) {
    Nbar <- sum(Ps[(i-1):(i+1),(q-1):(q)]) - Ps[i,q]
  }
  if (i == nrow(Ps) && q == ncol(Ps)) {
    Nbar <- sum(Ps[(i-1):(i),(q-1):(q)]) - Ps[i,q]
  }
  if (i == 1 && q == ncol(Ps)) {
    Nbar <- sum(Ps[(i):(i+1),(q-1):(q)]) - Ps[i,q]
  }
  if (i == nrow(Ps) && q == 1) {
    Nbar <- sum(Ps[(i-1):(i),(q):(q+1)]) - Ps[i,q]
  }
  if (i == 1 && q == 1) {
    Nbar <- sum(Ps[(i):(i+1),(q):(q+1)]) - Ps[i,q]
  }
  Nbar
}
```
```{r}
get_prob_matrix <- function(Ps,Es, alpha, beta) {
  probs_older <- Ps
  for (i in 1:nrow(Ps)) { # rows
    for (q in 1:ncol(Ps)) { # columns
      Pcell <- Ps[i,q]
      Ecell <- Es[i,q]
      Nbar <- get_Nbar(Ps,i,q)
      Polder <- Ecell * ( ( (1-Pcell) * (Nbar/8) * alpha) + (Pcell * (Nbar/8) * beta) )
      probs_older[i,q] <- Polder
    }
  }
  probs_older
}
```

\vspace{12pt}

When a node is reached (moving from tips to root), the probability matrix for each lineage is normalized, and the two matrices are multiplied together.

# Species Range Data

We first need to set ranges for the extant lineages on the phylogeny above. We'll use random ranges generated by the `get_random_species_range()` function above, having arbitrarily chosen occupancy of 100 cells for species A, C, and E and 500 cells for species B and D.

\vspace{12pt}

```{r eval = FALSE}
speciesA <- get_random_species_range(100,100, 100)
image(speciesA,main="SpeciesA Range")
speciesB <- get_random_species_range(100,100, 500)
image(speciesB,main = "SpeciesB Range")
speciesC <- get_random_species_range(100,100, 100)
image(speciesC,main = "SpeciesC Range")
speciesD <- get_random_species_range(100,100, 500)
image(speciesD,main="SpeciesD Range")
speciesE <- get_random_species_range(100,100, 100)
image(speciesE,main="SpeciesE Range")
```
```{r echo = FALSE,fig.height=3,fig.width=2}
par(mar = c(3,2.5,3,2.5))
speciesA <- as.matrix(read.csv("SpeciesA.csv"))
image(speciesA,main="SpeciesA Range",cex.main = .7)
speciesB <- as.matrix(read.csv("SpeciesB.csv"))
image(speciesB,main = "SpeciesB Range",cex.main = .7)
speciesC <- as.matrix(read.csv("SpeciesC.csv"))
image(speciesC,main = "SpeciesC Range",cex.main = .7)
speciesD <- as.matrix(read.csv("SpeciesD.csv"))
image(speciesD,main="SpeciesD Range",cex.main = .7)
speciesE <- as.matrix(read.csv("SpeciesE.csv"))
image(speciesE,main="SpeciesE Range",cex.main = .7)
```

\vspace{12pt}

Here we can see the random ranges generated for each species. Now we want to plot them beside our phylogeny -- easily accomplished with the `layout()` function.

\vspace{12pt}

```{r}
Ntip <- length(tree$tip.label)
layoutmatrix <- matrix(c(rep(1,Ntip),2:(Ntip+1)),ncol=2)
layout(layoutmatrix,widths = c(.8,.2))
par(mar = c(.5,.5,.5,0))
plot.phylo(tree,cex = 2)
#par(mar = c(2,1,2,3))
par(mar = c(0.5,0,0.5,0))
image(speciesE,xaxt='n', yaxt='n', ann=FALSE)
image(speciesD,xaxt='n', yaxt='n', ann=FALSE)
image(speciesC,xaxt='n', yaxt='n', ann=FALSE)
image(speciesB,xaxt='n', yaxt='n', ann=FALSE)
image(speciesA,xaxt='n', yaxt='n', ann=FALSE)
```
```{r include = F}
par(mar = c(0,0,0,0),mfrow = c(1,1))
```

\vspace{12pt}

# Scenario 1: Homogeneous environment

First, we want to make an environmental matrix that is completely homogeneous, where every cell is equally good for colonization by any species.

\vspace{12pt}

```{r}
Es <- matrix(nrow = 10,ncol = 10)
Es[1:100] <- 1
```

